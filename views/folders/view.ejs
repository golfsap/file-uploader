<h1>/<%= folder.name %></h1>

<!-- Share section -->
<div class="share-section">
  <h2>Share this folder</h2>
  <form action="" id="shareForm" style="margin-bottom: 15px">
    <label for="duration">Link expires in:</label>
    <select name="duration" id="duration" style="margin: 0 10px">
      <option value="1">1 hour</option>
      <option value="24">24 hours</option>
      <option value="168">7 days</option>
      <option value="720">30 days</option>
    </select>
    <button type="submit">Generate Link</button>
  </form>

  <div
    id="shareResult"
    style="
      display: none;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 3px;
    "
  >
    <p><strong>Share this link:</strong></p>
    <div style="display: flex; gap: 10px; margin: 10px 0">
      <input type="text" id="shareUrl" readonly style="flex: 1; padding: 5px" />
      <button onclick="copyToClipboard()">Copy Link</button>
    </div>
    <p style="font-size: 0.9em; color: #666">
      Expires: <span id="expiresAt"></span>
    </p>
  </div>

  <!-- Active Share Links -->
  <div id="activeShares" style="margin-top: 15px">
    <h3>Active Share Links</h3>
    <ul id="sharesList"></ul>
  </div>
</div>

<!-- upload Section -->
<h2>Upload a file</h2>
<form
  action="/files/upload/<%= folder.id %>"
  method="post"
  enctype="multipart/form-data"
>
  <input type="file" name="file" required />
  <button type="submit">Upload</button>
</form>

<h2>Files:</h2>
<ul>
  <% files.forEach(file => { %>
  <li>
    <a href="/files/<%= file.id %>"><%= file.name %></a>
    <button
      class="delete-btn"
      onclick="deleteFile(<%= file.id %>, <%= folder.id %>)"
    >
      Delete
    </button>
  </li>
  <% }) %>
</ul>
<a href="/folders">Back to all folders</a>

<script>
  const folderId = <%= folder.id %>;

  // Load active shared on page load
  document.addEventListener('DOMContentLoaded', loadActiveShares);

  // Generate share link
  document.getElementById('shareForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const duration = document.getElementById('duration').value;
    const folderId = <%= folder.id %>;

    try {
      const response = await fetch(`/folders/${folderId}/share`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ duration }),
      });

      const data = await response.json();

      if (data.success) {
        document.getElementById('shareUrl').value = data.shareUrl;
      document.getElementById('expiresAt').textContent = new Date(data.expiresAt).toLocaleString();
      document.getElementById('shareResult').style.display = 'block';
      }
    } catch (err) {
      alert('Error creating share link');
    }
  });

  function copyToClipboard() {
    const shareUrl = document.getElementById('shareUrl');
    shareUrl.select();
    shareUrl.setSelectionRange(0, 99999); // For mobile devices

    navigator.clipboard.writeText(shareUrl.value).then(() => {
      alert('Link copied to clipboard!');
    }).catch(() => {
      document.execCommand('copy');
      alert('Link copied to slipboard!');
    });
  }

  // Load active share links
  async function loadActiveShares() {
    try {
      const response = await fetch(`/folders/${folderId}/shares`);
      const data = await response.json();

      const sharesList = document.getElementById('sharesList');

      if (data.shares && data.shares.length > 0) {
        sharesList.innerHTML = data.shares.map(share => `
          <li style=" padding: 10px; background: #f9f9f9; border-radius: 3px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <code style="background: #fff; padding: 2px 5px; border-radius: 2px;">${window.location.origin}/shared/${share.token}</code>
              <br>
              <small style="color: #666;">Expires: ${new Date(share.expiresAt).toLocaleString()}</small>
            </div>
            <button onclick="revokeShare(${share.id})" style="background: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;"> Revoke </button>
          </div>
        </li>
        `).join("");
      } else {
        sharesList.innerHTML = '<li style="color: #666;">No active share links </li>';
      }
    } catch (err) {
      console.error('Error loading shares:', err);
    }
  }

  // Revoke share link
  async function revokeShare(shareId) {
    if (!confirm('Are you sure you want to revoke this share link?')) {
      return;
    }

    try {
      const response = await fetch(`/shares/${shareId}`, {
        method: "DELETE",
      });

      const data = await response.json();

      if (data.success) {
        alert('Share link revoked successfully');
        loadActiveShares();
      } else {
        alert(data.error || 'Error revoking share link');
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Error revoking share link');
    }
  }
</script>
